@inject IJSRuntime JSRuntime

<!-- Floating Buy Me a Coffee Button -->
<div style="position: fixed; bottom: 24px; right: 24px; z-index: 1000;">
    @if (!_isMinimized)
    {
        <MudPaper Elevation="8"
                  Style="background: linear-gradient(135deg, #FFDD00 0%, #FBB034 100%); border-radius: 50px; padding: 12px 24px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(251, 176, 52, 0.4);"
                  @onmouseenter="@(() => _isHovered = true)"
                  @onmouseleave="@(() => _isHovered = false)"
                  @onclick="NavigateToBuyMeACoffee">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Coffee"
                         Color="Color.Default"
                         Size="Size.Medium"
                         Style="color: #6F4E37;" />
                <MudText Typo="Typo.button"
                         Style="color: #6F4E37; font-weight: 600; white-space: nowrap;">
                    @(_isHovered ? "Support This Project!" : "Buy Me a Coffee")
                </MudText>
                <div @onclick:stopPropagation="true">
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Size="Size.Small"
                                   Style="color: #6F4E37;"
                                   OnClick="@MinimizeButton" />
                </div>
            </MudStack>
        </MudPaper>
    }
    else
    {
        <MudFab Color="Color.Warning"
                StartIcon="@Icons.Material.Filled.Coffee"
                OnClick="@(() => _isMinimized = false)"
                Size="Size.Large"
                Style="background: linear-gradient(135deg, #FFDD00 0%, #FBB034 100%); box-shadow: 0 4px 15px rgba(251, 176, 52, 0.4);" />
    }
</div>

<!-- Info Dialog -->
@if (_showDialog)
{
    <MudDialog IsVisible="_showDialog" Options="_dialogOptions">
    <DialogContent>
        <MudStack Spacing="3" AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.Coffee"
                     Color="Color.Warning"
                     Style="font-size: 64px;" />

            <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight: 600;">
                Support Stitch PDF Development
            </MudText>

            <MudText Typo="Typo.body1" Align="Align.Center">
                Stitch PDF is <strong>free and open source</strong>, built with passion to provide
                powerful PDF tools while protecting your privacy.
            </MudText>

            <MudPaper Elevation="0" Style="background-color: var(--mud-palette-info-lighten); padding: 16px; border-radius: 8px;">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.body2">
                        <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /> 100% client-side - your files never leave your device<br/>
                        <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /> Works offline as a Progressive Web App<br/>
                        <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /> No ads, no tracking, no hidden costs<br/>
                        <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /> Regular updates with new features
                    </MudText>
                </MudStack>
            </MudPaper>

            <MudText Typo="Typo.body1" Align="Align.Center">
                If you find this tool useful, consider buying me a coffee to support ongoing development! â˜•
            </MudText>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Warning"
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Filled.Coffee"
                       Href="https://buymeacoffee.com/rahmatsaeedi"
                       Target="_blank"
                       Style="font-weight: 600; padding: 12px 32px;">
                Buy Me a Coffee
            </MudButton>

            <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">
                Your support helps keep this project free and ad-free for everyone
            </MudText>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showDialog = false)" Color="Color.Primary">
            Maybe Later
        </MudButton>
    </DialogActions>
</MudDialog>
}

<style>
    /* Pulse animation for floating button */
    @@keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    .mud-fab:hover {
        animation: pulse 1s infinite;
    }
</style>

@code {
    private bool _isMinimized = false;
    private bool _isHovered = false;
    private bool _showDialog = false;

    private DialogOptions _dialogOptions = new DialogOptions
    {
        CloseButton = true,
        MaxWidth = MaxWidth.Small,
        FullWidth = true
    };

    protected override async Task OnInitializedAsync()
    {
        // Show the dialog automatically after 30 seconds of usage (only once per session)
        await Task.Delay(30000);
        var shown = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "coffeeDialogShown");
        if (string.IsNullOrEmpty(shown))
        {
            _showDialog = true;
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "coffeeDialogShown", "true");
            StateHasChanged();
        }
    }

    private void MinimizeButton()
    {
        _isMinimized = true;
    }

    private async Task NavigateToBuyMeACoffee(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        // Track the click with Google Analytics if available
        try
        {
            await JSRuntime.InvokeVoidAsync("gtag", "event", "click", new
            {
                event_category = "donation",
                event_label = "buy_me_a_coffee",
                value = 1
            });
        }
        catch { }

        // Open Buy Me a Coffee in new tab
        await JSRuntime.InvokeVoidAsync("open", "https://buymeacoffee.com/rahmatsaeedi", "_blank");
    }
}
