@using PdfMerger.Client.Models
@using PdfMerger.Client.Services
@using Microsoft.JSInterop
@using MudBlazor
@inject IJSRuntime JSRuntime
@inject ITouchGestureService TouchGestureService

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6">@FileName</MudText>

            @if (PageCount > 0)
            {
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Justify="Justify.SpaceBetween">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft"
                                       OnClick="PreviousPage"
                                       Disabled="@(_currentPage <= 1)"
                                       Color="Color.Primary" />
                        <MudText Typo="Typo.body1">
                            Page <strong>@_currentPage</strong> of <strong>@PageCount</strong>
                        </MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                                       OnClick="NextPage"
                                       Disabled="@(_currentPage >= PageCount)"
                                       Color="Color.Primary" />
                    </MudStack>

                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIconButton Icon="@Icons.Material.Filled.ZoomOut"
                                       OnClick="ZoomOut"
                                       Disabled="@(_zoomLevel <= 0.5)"
                                       Color="Color.Secondary"
                                       title="Zoom Out" />
                        <MudText Typo="Typo.body2">@((_zoomLevel * 100).ToString("F0"))%</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.ZoomIn"
                                       OnClick="ZoomIn"
                                       Disabled="@(_zoomLevel >= 3.0)"
                                       Color="Color.Secondary"
                                       title="Zoom In" />
                        <MudIconButton Icon="@Icons.Material.Filled.FitScreen"
                                       OnClick="ResetZoom"
                                       Color="Color.Secondary"
                                       title="Fit to Screen" />
                    </MudStack>
                </MudStack>

                <MudPaper id="pdf-preview-container" Elevation="1" Style="max-height: 70vh; overflow: auto; background-color: #f5f5f5; display: flex; justify-content: center; align-items: center; padding: 20px; touch-action: none;">
                    @if (!string.IsNullOrEmpty(_currentPageDataUrl))
                    {
                        <img src="@_currentPageDataUrl"
                             alt="Page @_currentPage"
                             style="@($"max-width: 100%; height: auto; transform: scale({_zoomLevel}); transition: transform 0.2s ease; user-select: none;")" />
                    }
                    else
                    {
                        <MudStack AlignItems="AlignItems.Center" Spacing="2" Style="padding: 40px;">
                            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Loading page...</MudText>
                        </MudStack>
                    }
                </MudPaper>
            }
            else
            {
                <MudAlert Severity="Severity.Info">No preview available for this file type.</MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string FileName { get; set; } = string.Empty;

    [Parameter]
    public byte[] PdfData { get; set; } = Array.Empty<byte>();

    [Parameter]
    public int PageCount { get; set; }

    private int _currentPage = 1;
    private double _zoomLevel = 1.0;
    private string? _currentPageDataUrl;

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentPage();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initialize touch gestures
            var success = await TouchGestureService.InitializeAsync("pdf-preview-container");
            if (success)
            {
                TouchGestureService.OnSwipe += HandleSwipe;
                TouchGestureService.OnPinch += HandlePinch;
            }
        }
    }

    private async Task LoadCurrentPage()
    {
        if (PdfData.Length == 0 || PageCount == 0) return;

        try
        {
            var module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/pdfInterop.js");
            _currentPageDataUrl = await module.InvokeAsync<string>("generatePdfThumbnail", PdfData, _currentPage - 1, 2.0);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading page {_currentPage}: {ex.Message}");
        }
    }

    private async Task NextPage()
    {
        if (_currentPage < PageCount)
        {
            _currentPage++;
            _currentPageDataUrl = null;
            await LoadCurrentPage();
        }
    }

    private async Task PreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            _currentPageDataUrl = null;
            await LoadCurrentPage();
        }
    }

    private void ZoomIn()
    {
        if (_zoomLevel < 3.0)
        {
            _zoomLevel += 0.25;
        }
    }

    private void ZoomOut()
    {
        if (_zoomLevel > 0.5)
        {
            _zoomLevel -= 0.25;
        }
    }

    private void ResetZoom()
    {
        _zoomLevel = 1.0;
    }

    private void Close()
    {
        MudDialog.Close();
    }

    private void HandleSwipe(string direction)
    {
        if (direction == "left")
        {
            _ = NextPage();
        }
        else if (direction == "right")
        {
            _ = PreviousPage();
        }
    }

    private void HandlePinch(double scale)
    {
        if (scale > 1.1)
        {
            ZoomIn();
        }
        else if (scale < 0.9)
        {
            ZoomOut();
        }
    }

    public async ValueTask DisposeAsync()
    {
        TouchGestureService.OnSwipe -= HandleSwipe;
        TouchGestureService.OnPinch -= HandlePinch;
        await TouchGestureService.DisposeAsync("pdf-preview-container");
    }
}
