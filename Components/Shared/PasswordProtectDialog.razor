@using PdfMerger.Client.Services
@using PdfMerger.Client.Models
@inject IAdvancedPdfService AdvancedPdfService

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            @if (!_isProcessing && string.IsNullOrEmpty(_resultMessage))
            {
                <MudText Typo="Typo.h6">Password Protect PDF</MudText>

                @if (Files.Count > 1)
                {
                    <MudSelect @bind-Value="_selectedFile" Label="Select PDF File" Variant="Variant.Outlined">
                        @foreach (var file in Files)
                        {
                            <MudSelectItem Value="@file">@file.Name</MudSelectItem>
                        }
                    </MudSelect>
                }
                else if (Files.Count == 1)
                {
                    <MudAlert Severity="Severity.Info">
                        <strong>File:</strong> @Files[0].Name
                    </MudAlert>
                }

                <MudTextField @bind-Value="_userPassword"
                              Label="User Password"
                              Variant="Variant.Outlined"
                              InputType="@(_showUserPassword ? InputType.Text : InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showUserPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@(() => _showUserPassword = !_showUserPassword)"
                              HelperText="Required to open the PDF"
                              Required="true" />

                <MudTextField @bind-Value="_userPasswordConfirm"
                              Label="Confirm User Password"
                              Variant="Variant.Outlined"
                              InputType="@(_showUserPassword ? InputType.Text : InputType.Password)"
                              HelperText="Re-enter the same password"
                              Required="true"
                              Error="@(!string.IsNullOrEmpty(_userPasswordConfirm) && _userPassword != _userPasswordConfirm)"
                              ErrorText="Passwords do not match" />

                <MudDivider />

                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Advanced Options (Optional)
                </MudText>

                <MudSwitch @bind-Value="_useOwnerPassword" Color="Color.Primary">
                    Set Owner Password (Advanced)
                </MudSwitch>

                @if (_useOwnerPassword)
                {
                    <MudTextField @bind-Value="_ownerPassword"
                                  Label="Owner Password"
                                  Variant="Variant.Outlined"
                                  InputType="@(_showOwnerPassword ? InputType.Text : InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_showOwnerPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                  OnAdornmentClick="@(() => _showOwnerPassword = !_showOwnerPassword)"
                                  HelperText="Required to modify permissions and security settings" />

                    <MudTextField @bind-Value="_ownerPasswordConfirm"
                                  Label="Confirm Owner Password"
                                  Variant="Variant.Outlined"
                                  InputType="@(_showOwnerPassword ? InputType.Text : InputType.Password)"
                                  HelperText="Re-enter the same password"
                                  Error="@(!string.IsNullOrEmpty(_ownerPasswordConfirm) && _ownerPassword != _ownerPasswordConfirm)"
                                  ErrorText="Passwords do not match" />

                    <MudAlert Severity="Severity.Info" Dense="true">
                        <MudText Typo="Typo.caption">
                            <strong>User Password:</strong> Required to open and view the PDF<br />
                            <strong>Owner Password:</strong> Required to change security settings and permissions
                        </MudText>
                    </MudAlert>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Dense="true">
                        <MudText Typo="Typo.caption">
                            The user password will protect the PDF from being opened without the correct password.
                        </MudText>
                    </MudAlert>
                }

                <MudAlert Severity="Severity.Warning" Dense="true">
                    <MudText Typo="Typo.caption">
                        <strong>⚠️ Important:</strong> Make sure to remember your password! There is no way to recover a forgotten password.
                    </MudText>
                </MudAlert>

                @if (!string.IsNullOrEmpty(_strengthMessage))
                {
                    <MudAlert Severity="@_strengthSeverity" Dense="true">
                        @_strengthMessage
                    </MudAlert>
                }
            }

            @if (_isProcessing)
            {
                <MudStack Spacing="2" AlignItems="AlignItems.Center">
                    <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                    <MudText Typo="Typo.h6">Encrypting PDF...</MudText>
                </MudStack>
            }

            @if (!string.IsNullOrEmpty(_resultMessage))
            {
                <MudAlert Severity="Severity.Success">
                    @_resultMessage
                </MudAlert>
            }

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error">
                    @_errorMessage
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">@(string.IsNullOrEmpty(_resultMessage) ? "Cancel" : "Close")</MudButton>
        @if (string.IsNullOrEmpty(_resultMessage) && !_isProcessing)
        {
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="ProtectPdf"
                       Disabled="@(!IsInputValid())">
                Protect PDF
            </MudButton>
        }
        @if (!string.IsNullOrEmpty(_resultMessage))
        {
            <MudButton Color="Color.Secondary"
                       Variant="Variant.Outlined"
                       OnClick="StartNew">
                Protect Another PDF
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public List<FileItem> Files { get; set; } = new();

    private FileItem? _selectedFile;
    private string _userPassword = "";
    private string _userPasswordConfirm = "";
    private string _ownerPassword = "";
    private string _ownerPasswordConfirm = "";
    private bool _useOwnerPassword = false;
    private bool _showUserPassword = false;
    private bool _showOwnerPassword = false;
    private bool _isProcessing;
    private string _resultMessage = "";
    private string _errorMessage = "";
    private string _strengthMessage = "";
    private Severity _strengthSeverity = Severity.Info;

    protected override void OnInitialized()
    {
        _selectedFile = Files.FirstOrDefault();
    }

    protected override void OnParametersSet()
    {
        CheckPasswordStrength();
    }

    private bool IsInputValid()
    {
        if (_selectedFile == null) return false;
        if (string.IsNullOrWhiteSpace(_userPassword)) return false;
        if (_userPassword != _userPasswordConfirm) return false;
        if (_useOwnerPassword)
        {
            if (string.IsNullOrWhiteSpace(_ownerPassword)) return false;
            if (_ownerPassword != _ownerPasswordConfirm) return false;
        }
        return true;
    }

    private void CheckPasswordStrength()
    {
        if (string.IsNullOrEmpty(_userPassword))
        {
            _strengthMessage = "";
            return;
        }

        int score = 0;
        if (_userPassword.Length >= 8) score++;
        if (_userPassword.Length >= 12) score++;
        if (_userPassword.Any(char.IsUpper)) score++;
        if (_userPassword.Any(char.IsLower)) score++;
        if (_userPassword.Any(char.IsDigit)) score++;
        if (_userPassword.Any(c => !char.IsLetterOrDigit(c))) score++;

        if (score <= 2)
        {
            _strengthMessage = "⚠️ Weak password. Consider using a longer password with mixed case, numbers, and symbols.";
            _strengthSeverity = Severity.Warning;
        }
        else if (score <= 4)
        {
            _strengthMessage = "✓ Moderate password strength.";
            _strengthSeverity = Severity.Info;
        }
        else
        {
            _strengthMessage = "✓✓ Strong password!";
            _strengthSeverity = Severity.Success;
        }
    }

    private async Task ProtectPdf()
    {
        if (_selectedFile == null || !IsInputValid()) return;

        _isProcessing = true;
        _errorMessage = "";
        StateHasChanged();

        try
        {
            string? ownerPwd = _useOwnerPassword && !string.IsNullOrWhiteSpace(_ownerPassword)
                ? _ownerPassword
                : null;

            var result = await AdvancedPdfService.ProtectPdfAsync(_selectedFile.Data, _userPassword, ownerPwd);

            if (result != null)
            {
                MudDialog.Close(DialogResult.Ok(result));
            }
            else
            {
                _errorMessage = "Failed to protect PDF";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
            Console.WriteLine($"Password protect error: {ex}");
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private void StartNew()
    {
        _resultMessage = "";
        _errorMessage = "";
        _userPassword = "";
        _userPasswordConfirm = "";
        _ownerPassword = "";
        _ownerPasswordConfirm = "";
        _useOwnerPassword = false;
        StateHasChanged();
    }

    private void Close() => MudDialog.Cancel();

    [Inject] private ISnackbar Snackbar { get; set; } = null!;
}
