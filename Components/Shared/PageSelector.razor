@using PdfMerger.Client.Models
@using MudBlazor
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6">Select Pages from @FileName</MudText>

            @if (PageCount.HasValue && PageCount.Value > 0)
            {
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Style="flex-wrap: wrap;">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               OnClick="SelectAll">
                        Select All (@PageCount)
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               Size="Size.Small"
                               OnClick="DeselectAll">
                        Deselect All
                    </MudButton>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Selected: @SelectedPages.Count / @PageCount
                    </MudText>
                </MudStack>

                <MudDivider />

                <div style="max-height: 500px; overflow-y: auto;">
                    <MudGrid Spacing="2">
                        @for (int i = 1; i <= PageCount.Value; i++)
                        {
                            var pageNum = i; // Capture for lambda
                            var isSelected = SelectedPages.Contains(pageNum);
                            var rotation = PageRotations.ContainsKey(pageNum - 1) ? PageRotations[pageNum - 1] : 0;

                            <MudItem xs="6" sm="4" md="3">
                                <MudCard Style="@($"border: {(isSelected ? "3px solid var(--mud-palette-primary)" : "2px solid #e0e0e0")}; cursor: pointer; position: relative;")"
                                         @onclick="() => TogglePageSelection(pageNum)">
                                    <MudCardContent Style="padding: 12px; text-align: center;">
                                        <MudStack Spacing="1" AlignItems="AlignItems.Center">
                                            @if (_pageThumbnails.TryGetValue(pageNum, out var thumbnailUrl))
                                            {
                                                <div style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                                    <img src="@thumbnailUrl"
                                                         alt="Page @pageNum"
                                                         style="@($"max-width: 100%; max-height: 100%; transform: rotate({rotation}deg); transition: transform 0.3s ease;")" />
                                                </div>
                                            }
                                            else
                                            {
                                                <div style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center;">
                                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Primary" />
                                                </div>
                                            }

                                            <MudText Typo="Typo.body2" Style="font-weight: bold;">
                                                Page @pageNum
                                            </MudText>

                                            @if (rotation != 0)
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                                                    @(rotation)°
                                                </MudChip>
                                            }

                                            @if (isSelected)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle"
                                                         Color="Color.Success"
                                                         Size="Size.Small"
                                                         Style="position: absolute; top: 8px; right: 8px;" />
                                            }
                                        </MudStack>

                                        @* Rotation buttons *@
                                        <MudStack Row="true" Spacing="1" Justify="Justify.Center" Style="margin-top: 8px;" @onclick:stopPropagation="true">
                                            <MudIconButton Icon="@Icons.Material.Filled.RotateLeft"
                                                           Size="Size.Small"
                                                           Color="Color.Primary"
                                                           Variant="Variant.Filled"
                                                           OnClick="() => RotatePage(pageNum, -90)"
                                                           title="Rotate Left 90°" />
                                            <MudIconButton Icon="@Icons.Material.Filled.RotateRight"
                                                           Size="Size.Small"
                                                           Color="Color.Primary"
                                                           Variant="Variant.Filled"
                                                           OnClick="() => RotatePage(pageNum, 90)"
                                                           title="Rotate Right 90°" />
                                        </MudStack>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                </div>
            }
            else
            {
                <MudText Color="Color.Secondary">No pages available</MudText>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">Apply</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string FileName { get; set; } = string.Empty;

    [Parameter]
    public int? PageCount { get; set; }

    [Parameter]
    public List<int> SelectedPages { get; set; } = new();

    [Parameter]
    public Dictionary<int, int> PageRotations { get; set; } = new();

    [Parameter]
    public byte[] PdfData { get; set; } = Array.Empty<byte>();

    private Dictionary<int, string> _pageThumbnails = new();
    private IJSObjectReference? _pdfModule;

    private void TogglePageSelection(int pageNum)
    {
        if (SelectedPages.Contains(pageNum))
        {
            SelectedPages.Remove(pageNum);
        }
        else
        {
            SelectedPages.Add(pageNum);
        }
    }

    private void SelectAll()
    {
        if (!PageCount.HasValue) return;

        SelectedPages.Clear();
        for (int i = 1; i <= PageCount.Value; i++)
        {
            SelectedPages.Add(i);
        }
    }

    private void DeselectAll()
    {
        SelectedPages.Clear();
    }

    private void RotatePage(int pageNum, int degrees)
    {
        int pageIndex = pageNum - 1; // Convert to 0-indexed

        if (PageRotations.ContainsKey(pageIndex))
        {
            PageRotations[pageIndex] = (PageRotations[pageIndex] + degrees) % 360;
            // Normalize negative rotations
            if (PageRotations[pageIndex] < 0)
                PageRotations[pageIndex] += 360;
            // Remove if back to 0
            if (PageRotations[pageIndex] == 0)
                PageRotations.Remove(pageIndex);
        }
        else
        {
            int normalizedDegrees = degrees % 360;
            if (normalizedDegrees < 0) normalizedDegrees += 360;
            if (normalizedDegrees != 0)
                PageRotations[pageIndex] = normalizedDegrees;
        }
    }

    private void Submit()
    {
        MudDialog.Close(DialogResult.Ok(new { SelectedPages, PageRotations }));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && PageCount.HasValue && PageCount.Value > 0 && PdfData.Length > 0)
        {
            try
            {
                _pdfModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/pdfInterop.js");

                // Generate thumbnails for all pages (async in background)
                _ = Task.Run(async () =>
                {
                    for (int pageNum = 1; pageNum <= PageCount.Value; pageNum++)
                    {
                        try
                        {
                            var thumbnailUrl = await _pdfModule.InvokeAsync<string>("generatePdfPageThumbnail", PdfData, pageNum);
                            _pageThumbnails[pageNum] = thumbnailUrl;
                            await InvokeAsync(StateHasChanged);
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Failed to generate thumbnail for page {pageNum}: {ex.Message}");
                        }
                    }
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading PDF module: {ex.Message}");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_pdfModule != null)
        {
            try
            {
                await _pdfModule.DisposeAsync();
            }
            catch { }
        }
    }
}
