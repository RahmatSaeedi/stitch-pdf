@using PdfMerger.Client.Models
@using PdfMerger.Client.Services
@inject ITemplateService TemplateService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@implements IDisposable

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <div class="d-flex justify-space-between align-center">
                <MudText Typo="Typo.h6">Saved Templates</MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="OpenCreateTemplateDialog">
                    Create Template
                </MudButton>
            </div>

            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Color="Color.Primary">
                <MudTabPanel Text="All" Icon="@Icons.Material.Filled.Apps" BadgeData="@_templates.Count" BadgeColor="Color.Info">
                    @if (_templates.Any())
                    {
                        <MudGrid Class="mt-3">
                            @foreach (var template in _templates)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <MudCard Elevation="2">
                                        <MudCardContent>
                                            <MudStack Spacing="2">
                                                <div class="d-flex justify-space-between align-center">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                        <MudIcon Icon="@GetTemplateIcon(template)" Color="Color.Primary" Size="Size.Small" />
                                                        <MudText Typo="Typo.subtitle1" Style="font-weight: 500;">@template.Name</MudText>
                                                    </MudStack>
                                                    <MudIconButton Icon="@(template.IsFavorite ? Icons.Material.Filled.Star : Icons.Material.Filled.StarBorder)"
                                                                   Color="@(template.IsFavorite ? Color.Warning : Color.Default)"
                                                                   Size="Size.Small"
                                                                   OnClick="@(() => ToggleFavorite(template.Id))"
                                                                   title="@(template.IsFavorite ? "Remove from favorites" : "Add to favorites")" />
                                                </div>

                                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                    @template.Description
                                                </MudText>

                                                <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                                                    @if (!string.IsNullOrEmpty(template.Category))
                                                    {
                                                        <MudText Typo="Typo.caption" Color="Color.Primary" Style="background-color: var(--mud-palette-primary-lighten); padding: 2px 8px; border-radius: 4px;">
                                                            @template.Category
                                                        </MudText>
                                                    }
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        Used @template.UsageCount times
                                                    </MudText>
                                                </MudStack>
                                            </MudStack>
                                        </MudCardContent>
                                        <MudCardActions>
                                            <MudButton Size="Size.Small"
                                                       Color="Color.Primary"
                                                       StartIcon="@Icons.Material.Filled.PlayArrow"
                                                       OnClick="@(() => ApplyTemplate(template.Id))">
                                                Apply
                                            </MudButton>
                                            <MudButton Size="Size.Small"
                                                       Color="Color.Secondary"
                                                       StartIcon="@Icons.Material.Filled.Edit"
                                                       OnClick="@(() => EditTemplate(template))">
                                                Edit
                                            </MudButton>
                                            <MudButton Size="Size.Small"
                                                       Color="Color.Error"
                                                       StartIcon="@Icons.Material.Filled.Delete"
                                                       OnClick="@(() => DeleteTemplate(template.Id))">
                                                Delete
                                            </MudButton>
                                        </MudCardActions>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudPaper Elevation="0" Class="pa-6 mt-3">
                            <MudStack AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Size="Size.Large" Color="Color.Secondary" />
                                <MudText Typo="Typo.body1" Color="Color.Secondary">
                                    No templates yet. Create your first template!
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    }
                </MudTabPanel>

                <MudTabPanel Text="Favorites" Icon="@Icons.Material.Filled.Star" BadgeData="@_favoriteTemplates.Count" BadgeColor="Color.Warning">
                    @if (_favoriteTemplates.Any())
                    {
                        <MudGrid Class="mt-3">
                            @foreach (var template in _favoriteTemplates)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <MudCard Elevation="2">
                                        <MudCardContent>
                                            <MudStack Spacing="2">
                                                <div class="d-flex justify-space-between align-center">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                        <MudIcon Icon="@GetTemplateIcon(template)" Color="Color.Primary" Size="Size.Small" />
                                                        <MudText Typo="Typo.subtitle1" Style="font-weight: 500;">@template.Name</MudText>
                                                    </MudStack>
                                                    <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" />
                                                </div>

                                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                    @template.Description
                                                </MudText>
                                            </MudStack>
                                        </MudCardContent>
                                        <MudCardActions>
                                            <MudButton Size="Size.Small"
                                                       Color="Color.Primary"
                                                       StartIcon="@Icons.Material.Filled.PlayArrow"
                                                       OnClick="@(() => ApplyTemplate(template.Id))">
                                                Apply
                                            </MudButton>
                                        </MudCardActions>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudPaper Elevation="0" Class="pa-6 mt-3">
                            <MudStack AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.StarBorder" Size="Size.Large" Color="Color.Secondary" />
                                <MudText Typo="Typo.body1" Color="Color.Secondary">
                                    No favorite templates. Star a template to add it here!
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    }
                </MudTabPanel>
            </MudTabs>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    private List<Template> _templates = new();
    private List<Template> _favoriteTemplates = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplates();
        TemplateService.OnTemplatesChanged += HandleTemplatesChanged;
    }

    private async Task LoadTemplates()
    {
        _templates = await TemplateService.GetAllTemplatesAsync();
        _favoriteTemplates = await TemplateService.GetFavoriteTemplatesAsync();
    }

    private void HandleTemplatesChanged()
    {
        _ = InvokeAsync(async () =>
        {
            await LoadTemplates();
            StateHasChanged();
        });
    }

    private async Task ApplyTemplate(Guid id)
    {
        var template = await TemplateService.GetTemplateAsync(id);
        if (template == null) return;

        await TemplateService.IncrementUsageAsync(id);
        Snackbar.Add($"Template '{template.Name}' applied!", Severity.Success);
        MudDialog.Close(DialogResult.Ok(template));
    }

    private async Task ToggleFavorite(Guid id)
    {
        await TemplateService.ToggleFavoriteAsync(id);
        await LoadTemplates();
    }

    private async Task DeleteTemplate(Guid id)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete Template",
            "Are you sure you want to delete this template?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            await TemplateService.DeleteTemplateAsync(id);
            await LoadTemplates();
            Snackbar.Add("Template deleted", Severity.Info);
        }
    }

    private async Task EditTemplate(Template template)
    {
        var parameters = new DialogParameters
        {
            { "ExistingTemplate", template }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<CreateEditTemplateDialog>(
            "Edit Template",
            parameters,
            options
        );

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadTemplates();
        }
    }

    private async Task OpenCreateTemplateDialog()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<CreateEditTemplateDialog>("Create Template", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadTemplates();
        }
    }

    private string GetTemplateIcon(Template template)
    {
        if (!string.IsNullOrEmpty(template.Icon))
        {
            return template.Icon switch
            {
                "merge" => Icons.Material.Filled.Merge,
                "print" => Icons.Material.Filled.Print,
                "web" => Icons.Material.Filled.Language,
                "compress" => Icons.Material.Filled.Compress,
                "security" => Icons.Material.Filled.Security,
                "gavel" => Icons.Material.Filled.Gavel,
                "receipt" => Icons.Material.Filled.Receipt,
                "photo_library" => Icons.Material.Filled.PhotoLibrary,
                _ => Icons.Material.Filled.Description
            };
        }

        return template.Type switch
        {
            TemplateType.MergeSettings => Icons.Material.Filled.Merge,
            TemplateType.ConversionSettings => Icons.Material.Filled.Transform,
            TemplateType.BatchOperation => Icons.Material.Filled.WorkOutline,
            TemplateType.AdvancedOperation => Icons.Material.Filled.Settings,
            _ => Icons.Material.Filled.Description
        };
    }

    private void Close()
    {
        MudDialog.Close();
    }

    public void Dispose()
    {
        TemplateService.OnTemplatesChanged -= HandleTemplatesChanged;
    }
}
