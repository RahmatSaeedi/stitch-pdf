@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div @ref="_uploadZone" class="file-upload-zone" style="border: 2px dashed #bdbdbd; border-radius: 8px; min-height: 200px; cursor: pointer; transition: all 0.2s ease;">
    <MudPaper Elevation="0" Class="pa-8 d-flex flex-column align-center justify-center" Style="background: transparent; height: 100%;">
        <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                       @ref="_fileUpload"
                       FilesChanged="OnFilesSelectedAsync"
                       Accept=".pdf,.png,.jpg,.jpeg,.webp,.gif,.bmp,.svg,.heic,.heif,.tif,.tiff,.avif,.txt,.md,.markdown,.csv,.html,.htm,.zip,.docx,.xlsx,.xls,.ods"
                       MaximumFileCount="100">
            <ActivatorContent>
                <MudStack AlignItems="AlignItems.Center" Spacing="3">
                    <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Large" Color="Color.Primary" Style="font-size: 64px;" />
                    <MudText Typo="Typo.h6" Color="Color.Primary">Drop files here or click to upload</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">PDF • Images (PNG, JPG, WebP, GIF, BMP, SVG, HEIC, TIFF, AVIF) • Documents (TXT, MD, CSV, HTML, DOCX, XLSX, XLS, ODS) • ZIP</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Max 1GB per file, 4GB total</MudText>
                </MudStack>
            </ActivatorContent>
        </MudFileUpload>
    </MudPaper>
</div>

@code {
    [Parameter]
    public EventCallback<IReadOnlyList<IBrowserFile>> FilesSelected { get; set; }

    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _fileUpload;
    private ElementReference _uploadZone;
    private IJSObjectReference? _jsModule;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/fileUpload.js");

                // Initialize the upload zone with JavaScript for better drag-and-drop handling
                await _jsModule.InvokeVoidAsync("initializeFileUploadZone", _uploadZone);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing file upload zone: {ex.Message}");
            }
        }
    }

    private async Task OnFilesSelectedAsync(IReadOnlyList<IBrowserFile> files)
    {
        if (files == null || files.Count == 0)
        {
            return;
        }

        await FilesSelected.InvokeAsync(files);
    }

    public async ValueTask DisposeAsync()
    {
        if (_jsModule != null)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("cleanupFileUploadZone", _uploadZone);
                await _jsModule.DisposeAsync();
            }
            catch { }
        }
    }
}
