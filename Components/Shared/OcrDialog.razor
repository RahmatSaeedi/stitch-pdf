@using PdfMerger.Client.Services
@using PdfMerger.Client.Models
@inject IOcrService OcrService

<style>
    .ocr-dialog-content {
        max-height: 80vh;
        overflow-y: auto;
    }

    @@media (max-width: 768px) {
        .ocr-dialog-content {
            max-height: 70vh;
        }

        .mud-dialog {
            margin: 8px !important;
        }

        .mud-dialog-content {
            padding: 12px !important;
        }
    }

    .mud-select-input {
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .mud-popover {
        max-height: 400px !important;
    }
</style>

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3" Class="ocr-dialog-content">
            @if (!_isProcessing && string.IsNullOrEmpty(_extractedText))
            {
                <MudText Typo="Typo.h6">Extract Text with OCR</MudText>

                @if (Files.Count > 1)
                {
                    <MudSelect @bind-Value="_selectedFile" Label="Select File" Variant="Variant.Outlined">
                        @foreach (var file in Files)
                        {
                            <MudSelectItem Value="@file">@file.Name</MudSelectItem>
                        }
                    </MudSelect>
                }
                else if (Files.Count == 1)
                {
                    <MudAlert Severity="Severity.Info">
                        <strong>File:</strong> @Files[0].Name
                    </MudAlert>
                }

                <MudSelect @bind-Value="_selectedLanguage"
                           Label="Language"
                           Variant="Variant.Outlined"
                           Dense="true"
                           MaxHeight="400">
                    @foreach (var lang in _availableLanguages)
                    {
                        <MudSelectItem Value="@lang.Code">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">@lang.Flag</span>
                                <span style="font-weight: 500;">@lang.NativeName</span>
                                @if (!string.IsNullOrEmpty(lang.EnglishName) && lang.NativeName != lang.EnglishName)
                                {
                                    <span style="color: #888; font-size: 0.85em;">(@lang.EnglishName)</span>
                                }
                            </div>
                        </MudSelectItem>
                    }
                </MudSelect>

                <MudAlert Severity="Severity.Info" Dense="true">
                    <MudText Typo="Typo.caption">
                        OCR will extract text from the selected @(IsImage(_selectedFile) ? "image" : "PDF").
                        First-time language download may take a few seconds.
                    </MudText>
                </MudAlert>
            }

            @if (_isProcessing)
            {
                <MudStack Spacing="2" AlignItems="AlignItems.Center">
                    <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                    <MudText Typo="Typo.h6">Processing OCR...</MudText>
                    @if (_progress > 0)
                    {
                        <MudProgressLinear Color="Color.Primary" Value="@_progress" Size="Size.Medium" Class="rounded" />
                        <MudText Typo="Typo.body2">@_progress% complete</MudText>
                    }
                    @if (!string.IsNullOrEmpty(_statusMessage))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@_statusMessage</MudText>
                    }
                </MudStack>
            }

            @if (!string.IsNullOrEmpty(_extractedText))
            {
                <MudStack Spacing="2">
                    <div class="d-flex justify-space-between align-center">
                        <MudText Typo="Typo.h6">Extracted Text</MudText>
                        <MudButton StartIcon="@Icons.Material.Filled.ContentCopy"
                                   OnClick="CopyToClipboard"
                                   Variant="Variant.Outlined"
                                   Size="Size.Small"
                                   Color="Color.Primary">
                            Copy
                        </MudButton>
                    </div>

                    @if (_confidence > 0)
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetConfidenceColor(_confidence)">
                            Confidence: @_confidence.ToString("F1")%
                        </MudChip>
                    }

                    <MudPaper Elevation="0" Class="pa-4" Style="background-color: #f5f5f5; max-height: 400px; overflow-y: auto;">
                        <MudText Typo="Typo.body2" Style="white-space: pre-wrap; font-family: monospace;">@_extractedText</MudText>
                    </MudPaper>

                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @_wordCount words extracted
                    </MudText>
                </MudStack>
            }

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error">
                    @_errorMessage
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">@(string.IsNullOrEmpty(_extractedText) ? "Cancel" : "Close")</MudButton>
        @if (string.IsNullOrEmpty(_extractedText) && !_isProcessing)
        {
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="PerformOCR"
                       Disabled="@(_selectedFile == null)">
                Extract Text
            </MudButton>
        }
        @if (!string.IsNullOrEmpty(_extractedText))
        {
            <MudButton Color="Color.Secondary"
                       Variant="Variant.Outlined"
                       OnClick="StartNew">
                Extract Another
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public List<FileItem> Files { get; set; } = new();

    private FileItem? _selectedFile;
    private string _selectedLanguage = "eng";
    private bool _isProcessing;
    private int _progress;
    private string _statusMessage = "";
    private string _extractedText = "";
    private string _errorMessage = "";
    private float _confidence;
    private int _wordCount;

    private record OcrLanguage(string Code, string Flag, string NativeName, string EnglishName = "");

    private readonly List<OcrLanguage> _availableLanguages = new()
    {
        // Top 30 by internet users
        new("eng", "ğŸ‡¬ğŸ‡§", "English"),
        new("chi_sim", "ğŸ‡¨ğŸ‡³", "ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰", "Chinese (Simplified)"),
        new("chi_tra", "ğŸ‡¹ğŸ‡¼", "ä¸­æ–‡ï¼ˆç¹é«”ï¼‰", "Chinese (Traditional)"),
        new("spa", "ğŸ‡ªğŸ‡¸", "EspaÃ±ol", "Spanish"),
        new("ara", "ğŸ‡¸ğŸ‡¦", "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Arabic"),
        new("por", "ğŸ‡µğŸ‡¹", "PortuguÃªs", "Portuguese"),
        new("ind", "ğŸ‡®ğŸ‡©", "Bahasa Indonesia", "Indonesian"),
        new("fra", "ğŸ‡«ğŸ‡·", "FranÃ§ais", "French"),
        new("jpn", "ğŸ‡¯ğŸ‡µ", "æ—¥æœ¬èª", "Japanese"),
        new("rus", "ğŸ‡·ğŸ‡º", "Ğ ÑƒÑÑĞºĞ¸Ğ¹", "Russian"),
        new("deu", "ğŸ‡©ğŸ‡ª", "Deutsch", "German"),
        new("hin", "ğŸ‡®ğŸ‡³", "à¤¹à¤¿à¤¨à¥à¤¦à¥€", "Hindi"),
        new("ben", "ğŸ‡§ğŸ‡©", "à¦¬à¦¾à¦‚à¦²à¦¾", "Bengali"),
        new("kor", "ğŸ‡°ğŸ‡·", "í•œêµ­ì–´", "Korean"),
        new("vie", "ğŸ‡»ğŸ‡³", "Tiáº¿ng Viá»‡t", "Vietnamese"),
        new("tur", "ğŸ‡¹ğŸ‡·", "TÃ¼rkÃ§e", "Turkish"),
        new("ita", "ğŸ‡®ğŸ‡¹", "Italiano", "Italian"),
        new("tha", "ğŸ‡¹ğŸ‡­", "à¸ à¸²à¸©à¸²à¹„à¸—à¸¢", "Thai"),
        new("pol", "ğŸ‡µğŸ‡±", "Polski", "Polish"),
        new("nld", "ğŸ‡³ğŸ‡±", "Nederlands", "Dutch"),
        new("ukr", "ğŸ‡ºğŸ‡¦", "Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°", "Ukrainian"),
        new("fas", "ğŸ‡®ğŸ‡·", "ÙØ§Ø±Ø³ÛŒ", "Persian"),
        new("tgl", "ğŸ‡µğŸ‡­", "Tagalog", "Filipino"),
        new("ron", "ğŸ‡·ğŸ‡´", "RomÃ¢nÄƒ", "Romanian"),
        new("ell", "ğŸ‡¬ğŸ‡·", "Î•Î»Î»Î·Î½Î¹ÎºÎ¬", "Greek"),
        new("heb", "ğŸ‡®ğŸ‡±", "×¢×‘×¨×™×ª", "Hebrew"),
        new("ces", "ğŸ‡¨ğŸ‡¿", "ÄŒeÅ¡tina", "Czech"),
        new("swe", "ğŸ‡¸ğŸ‡ª", "Svenska", "Swedish"),
        new("hun", "ğŸ‡­ğŸ‡º", "Magyar", "Hungarian"),
        new("msa", "ğŸ‡²ğŸ‡¾", "Bahasa Melayu", "Malay"),

        // Rest alphabetically
        new("afr", "ğŸ‡¿ğŸ‡¦", "Afrikaans"),
        new("amh", "ğŸ‡ªğŸ‡¹", "áŠ áˆ›áˆ­áŠ›", "Amharic"),
        new("asm", "ğŸ‡®ğŸ‡³", "à¦…à¦¸à¦®à§€à¦¯à¦¼à¦¾", "Assamese"),
        new("aze", "ğŸ‡¦ğŸ‡¿", "AzÉ™rbaycanca", "Azerbaijani"),
        new("bel", "ğŸ‡§ğŸ‡¾", "Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑĞºĞ°Ñ", "Belarusian"),
        new("bod", "ğŸ”ï¸", "à½–à½¼à½‘à¼‹à½¡à½²à½‚", "Tibetan"),
        new("bos", "ğŸ‡§ğŸ‡¦", "Bosanski", "Bosnian"),
        new("bre", "ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿", "Brezhoneg", "Breton"),
        new("bul", "ğŸ‡§ğŸ‡¬", "Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸", "Bulgarian"),
        new("cat", "ğŸ´ó ¥ó ³ó £ó ´ó ¿", "CatalÃ ", "Catalan"),
        new("ceb", "ğŸ‡µğŸ‡­", "Cebuano"),
        new("dan", "ğŸ‡©ğŸ‡°", "Dansk", "Danish"),
        new("dzo", "ğŸ‡§ğŸ‡¹", "à½¢à¾«à½¼à½„à¼‹à½", "Dzongkha"),
        new("epo", "ğŸŒ", "Esperanto"),
        new("est", "ğŸ‡ªğŸ‡ª", "Eesti", "Estonian"),
        new("eus", "ğŸ´ó ¥ó ³ó °ó ¶ó ¿", "Euskara", "Basque"),
        new("fin", "ğŸ‡«ğŸ‡®", "Suomi", "Finnish"),
        new("fry", "ğŸ‡³ğŸ‡±", "Frysk", "Frisian"),
        new("gla", "ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿", "GÃ idhlig", "Scottish Gaelic"),
        new("gle", "ğŸ‡®ğŸ‡ª", "Gaeilge", "Irish"),
        new("glg", "ğŸ´ó ¥ó ³ó §ó ¡ó ¿", "Galego", "Galician"),
        new("guj", "ğŸ‡®ğŸ‡³", "àª—à«àªœàª°àª¾àª¤à«€", "Gujarati"),
        new("hau", "ğŸ‡³ğŸ‡¬", "Hausa"),
        new("hrv", "ğŸ‡­ğŸ‡·", "Hrvatski", "Croatian"),
        new("hye", "ğŸ‡¦ğŸ‡²", "Õ€Õ¡ÕµÕ¥Ö€Õ¥Õ¶", "Armenian"),
        new("ibo", "ğŸ‡³ğŸ‡¬", "Igbo"),
        new("isl", "ğŸ‡®ğŸ‡¸", "Ãslenska", "Icelandic"),
        new("jav", "ğŸ‡®ğŸ‡©", "ê¦§ê¦±ê¦—ê¦®", "Javanese"),
        new("kan", "ğŸ‡®ğŸ‡³", "à²•à²¨à³à²¨à²¡", "Kannada"),
        new("kas", "ğŸ‡®ğŸ‡³", "à¤•à¥‰à¤¶à¥à¤°", "Kashmiri"),
        new("kat", "ğŸ‡¬ğŸ‡ª", "áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜", "Georgian"),
        new("kaz", "ğŸ‡°ğŸ‡¿", "ÒšĞ°Ğ·Ğ°Ò›ÑˆĞ°", "Kazakh"),
        new("khm", "ğŸ‡°ğŸ‡­", "á—á¶áŸá¶ááŸ’á˜áŸ‚áš", "Khmer"),
        new("kir", "ğŸ‡°ğŸ‡¬", "ĞšÑ‹Ñ€Ğ³Ñ‹Ğ·Ñ‡Ğ°", "Kyrgyz"),
        new("kok", "ğŸ‡®ğŸ‡³", "à¤•à¥‹à¤‚à¤•à¤£à¥€", "Konkani"),
        new("kur", "ğŸ´", "Ú©ÙˆØ±Ø¯ÛŒ", "Kurdish"),
        new("lao", "ğŸ‡±ğŸ‡¦", "àº¥àº²àº§", "Lao"),
        new("lat", "ğŸ›ï¸", "Latina", "Latin"),
        new("lav", "ğŸ‡±ğŸ‡»", "LatvieÅ¡u", "Latvian"),
        new("lit", "ğŸ‡±ğŸ‡¹", "LietuviÅ³", "Lithuanian"),
        new("mal", "ğŸ‡®ğŸ‡³", "à´®à´²à´¯à´¾à´³à´‚", "Malayalam"),
        new("mar", "ğŸ‡®ğŸ‡³", "à¤®à¤°à¤¾à¤ à¥€", "Marathi"),
        new("mkd", "ğŸ‡²ğŸ‡°", "ĞœĞ°ĞºĞµĞ´Ğ¾Ğ½ÑĞºĞ¸", "Macedonian"),
        new("mlt", "ğŸ‡²ğŸ‡¹", "Malti", "Maltese"),
        new("mni", "ğŸ‡®ğŸ‡³", "à¦®à§ˆà¦¤à§ˆà¦²à§‹à¦¨", "Manipuri"),
        new("mon", "ğŸ‡²ğŸ‡³", "ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»", "Mongolian"),
        new("mya", "ğŸ‡²ğŸ‡²", "á€™á€¼á€”á€ºá€™á€¬", "Burmese"),
        new("nep", "ğŸ‡³ğŸ‡µ", "à¤¨à¥‡à¤ªà¤¾à¤²à¥€", "Nepali"),
        new("nor", "ğŸ‡³ğŸ‡´", "Norsk", "Norwegian"),
        new("oci", "ğŸ´ó ¥ó ³ó £ó ´ó ¿", "Occitan"),
        new("ori", "ğŸ‡®ğŸ‡³", "à¬“à¬¡à¬¼à¬¿à¬†", "Oriya"),
        new("orm", "ğŸ‡ªğŸ‡¹", "Oromoo", "Oromo"),
        new("pan", "ğŸ‡®ğŸ‡³", "à¨ªà©°à¨œà¨¾à¨¬à©€", "Punjabi"),
        new("pus", "ğŸ‡¦ğŸ‡«", "Ù¾ÚšØªÙˆ", "Pashto"),
        new("san", "ğŸ‡®ğŸ‡³", "à¤¸à¤‚à¤¸à¥à¤•à¥ƒà¤¤à¤®à¥", "Sanskrit"),
        new("sat", "ğŸ‡®ğŸ‡³", "á±¥á±Ÿá±±á±›á±Ÿá±²á±¤", "Santali"),
        new("sin", "ğŸ‡±ğŸ‡°", "à·ƒà·’à¶‚à·„à¶½", "Sinhala"),
        new("slk", "ğŸ‡¸ğŸ‡°", "SlovenÄina", "Slovak"),
        new("slv", "ğŸ‡¸ğŸ‡®", "SlovenÅ¡Äina", "Slovenian"),
        new("snd", "ğŸ‡µğŸ‡°", "Ø³Ù†ÚŒÙŠ", "Sindhi"),
        new("som", "ğŸ‡¸ğŸ‡´", "Soomaali", "Somali"),
        new("sqi", "ğŸ‡¦ğŸ‡±", "Shqip", "Albanian"),
        new("srp", "ğŸ‡·ğŸ‡¸", "Ğ¡Ñ€Ğ¿ÑĞºĞ¸", "Serbian"),
        new("sun", "ğŸ‡®ğŸ‡©", "Basa Sunda", "Sundanese"),
        new("swa", "ğŸ‡°ğŸ‡ª", "Kiswahili", "Swahili"),
        new("syr", "ğŸ´", "Ü£Ü˜ÜªÜÜÜ", "Syriac"),
        new("tam", "ğŸ‡®ğŸ‡³", "à®¤à®®à®¿à®´à¯", "Tamil"),
        new("tel", "ğŸ‡®ğŸ‡³", "à°¤à±†à°²à±à°—à±", "Telugu"),
        new("tgk", "ğŸ‡¹ğŸ‡¯", "Ğ¢Ğ¾Ò·Ğ¸ĞºÓ£", "Tajik"),
        new("tir", "ğŸ‡ªğŸ‡·", "á‰µáŒáˆ­áŠ›", "Tigrinya"),
        new("tuk", "ğŸ‡¹ğŸ‡²", "Ğ¢Ò¯Ñ€ĞºĞ¼ĞµĞ½", "Turkmen"),
        new("uig", "ğŸ‡¨ğŸ‡³", "Ø¦Û‡ÙŠØºÛ‡Ø±Ú†Û•", "Uyghur"),
        new("urd", "ğŸ‡µğŸ‡°", "Ø§Ø±Ø¯Ùˆ", "Urdu"),
        new("uzb", "ğŸ‡ºğŸ‡¿", "OÊ»zbekcha", "Uzbek"),
        new("xho", "ğŸ‡¿ğŸ‡¦", "isiXhosa", "Xhosa"),
        new("yid", "ğŸ•", "×™×™Ö´×“×™×©", "Yiddish"),
        new("yor", "ğŸ‡³ğŸ‡¬", "YorÃ¹bÃ¡", "Yoruba"),
        new("zul", "ğŸ‡¿ğŸ‡¦", "isiZulu", "Zulu"),
        new("cym", "ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿", "Cymraeg", "Welsh")
    };

    protected override void OnInitialized()
    {
        _selectedFile = Files.FirstOrDefault();
    }

    private bool IsImage(FileItem? file)
    {
        if (file == null) return false;
        return file.ContentType.StartsWith("image/");
    }

    private async Task PerformOCR()
    {
        if (_selectedFile == null) return;

        _isProcessing = true;
        _progress = 0;
        _statusMessage = "Initializing OCR engine...";
        _errorMessage = "";
        StateHasChanged();

        try
        {
            // Initialize OCR
            _statusMessage = "Downloading OCR language files (first time only)...";
            StateHasChanged();

            try
            {
                var initialized = await OcrService.InitializeAsync(_selectedLanguage);
                if (!initialized)
                {
                    _errorMessage = "Failed to initialize OCR engine. Please check your internet connection and try again.";
                    return;
                }
            }
            catch (Exception initEx)
            {
                _errorMessage = $"OCR Initialization Error: {initEx.Message}";
                Console.WriteLine($"OCR Init Exception: {initEx}");
                return;
            }

            if (_selectedFile.ContentType == "application/pdf")
            {
                _statusMessage = "Processing PDF pages...";
                StateHasChanged();

                var progress = new Progress<PdfOcrProgress>(p =>
                {
                    _progress = p.Percentage;
                    _statusMessage = $"Processing page {p.CurrentPage} of {p.TotalPages}...";
                    InvokeAsync(StateHasChanged);
                });

                var result = await OcrService.PerformOcrOnPdfAsync(_selectedFile.Data, _selectedLanguage, progress);

                if (result?.Success == true && result.Pages.Any())
                {
                    // Combine all pages
                    _extractedText = string.Join("\n\n--- Page Break ---\n\n",
                        result.Pages.Select(p => $"[Page {p.PageNumber}]\n{p.Text}"));
                    _confidence = result.Pages.Average(p => p.Confidence);
                    _wordCount = _extractedText.Split(new[] { ' ', '\n', '\r', '\t' },
                        StringSplitOptions.RemoveEmptyEntries).Length;
                }
                else
                {
                    _errorMessage = result?.Error ?? "Failed to extract text from PDF";
                }
            }
            else
            {
                // Process image
                _statusMessage = "Extracting text from image...";
                StateHasChanged();

                var progress = new Progress<int>(p =>
                {
                    _progress = p;
                    InvokeAsync(StateHasChanged);
                });

                var result = await OcrService.PerformOcrAsync(_selectedFile.Data, _selectedLanguage, progress);

                if (result != null && !string.IsNullOrEmpty(result.Text))
                {
                    _extractedText = result.Text;
                    _confidence = result.Confidence;
                    _wordCount = _extractedText.Split(new[] { ' ', '\n', '\r', '\t' },
                        StringSplitOptions.RemoveEmptyEntries).Length;
                }
                else
                {
                    _errorMessage = result?.Error ?? "No text found in image";
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"OCR Error: {ex.Message}";
            Console.WriteLine($"OCR Error: {ex}");
        }
        finally
        {
            _isProcessing = false;
            _progress = 0;
            _statusMessage = "";
            StateHasChanged();
        }
    }

    private async Task CopyToClipboard()
    {
        try
        {
            // Note: Clipboard API requires HTTPS or localhost
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _extractedText);
            Snackbar.Add("âœ… Text copied to clipboard!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("âš ï¸ Copy failed. Select and copy text manually.", Severity.Warning);
        }
    }

    private Color GetConfidenceColor(float confidence)
    {
        if (confidence >= 80) return Color.Success;
        if (confidence >= 60) return Color.Warning;
        return Color.Error;
    }

    private void StartNew()
    {
        _extractedText = "";
        _errorMessage = "";
        _confidence = 0;
        _wordCount = 0;
        StateHasChanged();
    }

    private void Close() => MudDialog.Cancel();

    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;
}
